<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>constructors/async.js - Application Prototype - Framework</title>
    
    <meta name="description" content="Application Prototype Framework based on Module Pattern" />
    
        <meta name="keywords" content="javascript, js, application-prototype, prototype" />
        <meta name="keyword" content="javascript, js, application-prototype, prototype" />
    
    
    
    <meta property="og:title" content="Application Prototype - Framework"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content="https://labs.sgapps.io/open-source/application-prototype"/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://labs.sgapps.io/open-source/application-prototype" target="_blank" class="menu-item" id="website_link" >Project Page ( Git Lab )</a></h2><h2><a href="http://gordienco.net/" target="_blank" class="menu-item" id="website_link" >About Me</a></h2><h2><a href="https://github.com/sergiu-gordienco/application-prototype" target="_blank" class="menu-item" id="github_link" >GitHub</a></h2><h3>Modules</h3><ul><li><a href="module-request.html">request</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-request.html#.params-parser">params-parser</a></li></ul></li><li><a href="module-uri-load.html">uri-load</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-uri-load.html#.link">link</a></li><li data-type='method' style='display: none;'><a href="module-uri-load.html#.script">script</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="ApplicationPrototype.Builder.html">Builder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.consoleOptions">consoleOptions</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.debugEnabled">debugEnabled</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.isBrowser">isBrowser</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.isNode">isNode</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.modulePath">modulePath</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.moduleRegister">moduleRegister</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.require">require</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.html#.runModulesInFiles">runModulesInFiles</a></li></ul></li><li class="level-hide"><a href="ApplicationPrototype.Builder.Promise.html">Promise</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.Promise.html#.all">all</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.Promise.html#.race">race</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.Promise.html#.reject">reject</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Builder.Promise.html#.resolve">resolve</a></li></ul></li><li><a href="ApplicationPrototype.Instance.html">Instance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.bind">bind</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.crudEvents">crudEvents</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.off">off</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.on">on</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.once">once</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.property">property</a></li><li data-type='method' style='display: none;'><a href="ApplicationPrototype.Instance.html#.property">property</a></li></ul></li><li><a href="async.Async.html">Async</a><ul class='methods'><li data-type='method' style='display: none;'><a href="async.Async.html#done">done</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#errors">errors</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#index">index</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#processing">processing</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#receive">receive</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#reserve">reserve</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#responses">responses</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#run">run</a></li><li data-type='method' style='display: none;'><a href="async.Async.html#wait">wait</a></li></ul></li><li><a href="ExtensionsPrototype.slDOMSet.html">slDOMSet</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.add">add</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.attr">attr</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.attr">attr</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.attr">attr</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.attr">attr</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.config">config</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.config">config</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.each">each</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.env">env</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.eq">eq</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.filter">filter</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.find">find</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.map">map</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.set">set</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.set">set</a></li><li data-type='method' style='display: none;'><a href="ExtensionsPrototype.slDOMSet.html#.unique">unique</a></li></ul></li><li><a href="module-request.RequestModule.html">RequestModule</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-request.RequestModule.html#.READY_STATE_DONE">READY_STATE_DONE</a></li><li data-type='member' style='display: none;'><a href="module-request.RequestModule.html#.READY_STATE_HEADERS_RECEIVED">READY_STATE_HEADERS_RECEIVED</a></li><li data-type='member' style='display: none;'><a href="module-request.RequestModule.html#.READY_STATE_LOADING">READY_STATE_LOADING</a></li><li data-type='member' style='display: none;'><a href="module-request.RequestModule.html#.READY_STATE_OPENED">READY_STATE_OPENED</a></li><li data-type='member' style='display: none;'><a href="module-request.RequestModule.html#.READY_STATE_UNSENT">READY_STATE_UNSENT</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#async">async</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#async">async</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#config">config</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#configurator">configurator</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#headers">headers</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#headers">headers</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#method">method</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#method">method</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#open">open</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#readyState">readyState</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#request">request</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#response">response</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#send">send</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#status">status</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#statusText">statusText</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#timeout">timeout</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#timeout">timeout</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#url">url</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#url">url</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#withCredentials">withCredentials</a></li><li data-type='method' style='display: none;'><a href="module-request.RequestModule.html#withCredentials">withCredentials</a></li></ul></li></ul><h3>Events</h3><ul><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__afterGet">__afterGet</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__afterGet::propName">__afterGet::propName</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__afterSet">__afterSet</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__afterSet::propName">__afterSet::propName</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__onGet">__onGet</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__onGet::propName">__onGet::propName</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__onSet">__onSet</a></li><li class="level-hide"><a href="ApplicationPrototype.Instance.html#.event:__onSet::propName">__onSet::propName</a></li></ul><h3>Interfaces</h3><ul><li><a href="ApplicationPrototype.html">ApplicationPrototype</a></li><li><a href="async.html">async</a><ul class='methods'><li data-type='method' style='display: none;'><a href="async.html#.flow">flow</a></li><li data-type='method' style='display: none;'><a href="async.html#.flow%25C2%25B7map">flow路map</a></li><li data-type='method' style='display: none;'><a href="async.html#.map">map</a></li><li data-type='method' style='display: none;'><a href="async.html#.waterfall">waterfall</a></li><li data-type='method' style='display: none;'><a href="async.html#.waterfall%25C2%25B7map">waterfall路map</a></li></ul></li><li><a href="BrowserSessionModule.html">BrowserSessionModule</a><ul class='methods'><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.clear">clear</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.findItems">findItems</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.getItem">getItem</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.getItems">getItems</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.removeItem">removeItem</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.removeItems">removeItems</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.setItem">setItem</a></li><li data-type='method' style='display: none;'><a href="BrowserSessionModule.html#.setItems">setItems</a></li></ul></li><li><a href="ExtensionsPrototype.html">ExtensionsPrototype</a><ul class='members'><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#._">_</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.__">__</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.fn">fn</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.object">object</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.slDOM">slDOM</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.slDOM_env">slDOM_env</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.string">string</a></li><li data-type='member' style='display: none;'><a href="ExtensionsPrototype.html#.WindowExtend">WindowExtend</a></li></ul></li><li><a href="JSTemplate.html">JSTemplate</a><ul class='methods'><li data-type='method' style='display: none;'><a href="JSTemplate.html#.attrParser">attrParser</a></li><li data-type='method' style='display: none;'><a href="JSTemplate.html#.expressionBuilder">expressionBuilder</a></li><li data-type='method' style='display: none;'><a href="JSTemplate.html#.nodeParser">nodeParser</a></li><li data-type='method' style='display: none;'><a href="JSTemplate.html#.parseTextNodes">parseTextNodes</a></li><li data-type='method' style='display: none;'><a href="JSTemplate.html#.textParser">textParser</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ApplicationBuilderConstructor">ApplicationBuilderConstructor</a></li><li><a href="global.html#ApplicationBuilderExports">ApplicationBuilderExports</a></li><li><a href="global.html#ApplicationPrototypeConstructor">ApplicationPrototypeConstructor</a></li><li><a href="global.html#NodeInterface">NodeInterface</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">constructors/async.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @callback AsyncConstructor
 * @memberof async
 * @returns {async.Async}
 */

/**
 * Module used processing data asynchronous
 * @example
 * Application.require('async').then(function (asyncOperations) {
 *	// @TODO
 * }, console.error);
 * @interface async
 * @returns {async.AsyncConstructor}
 * @see async.Async
 */

/**
 * @class
 * @name Async
 * @memberof async
 */
var async	= function () {
	var life = 0;
	var waited	= 0;
	var received	= 0;
	var responsesId	= [];
	var responses	= {};
	var context = {};
	var app	= new ApplicationPrototype();


	/**
	 * return unique index identifier for an operation
	 * @method index
	 * @memberof async.Async#
	 * @returns {string}
	 */
	app.bind("index", ((function () {
		var index = 0;
		return function () {
			return life + '::' + ( ++index );
		};
	})()), '');


	/**
	 * method used for return result for an operation,
	 * returns `true` if value was accepted.
	 * if operation already obtained a value
	 * then value is not accepted and it returns `false`
	 * @method receive
	 * @memberof async.Async#
	 * @param {string} id obtained from {@link async.Async#index}
	 * @param {any} args
	 * @returns {boolean}
	 */
	app.bind("receive", function (id, args) {
		if (id) {
			if (id.indexOf(life+'::') !== 0) {
				return false;
			}
			responses[id]	= args;
		}
		received += 1;
		if (received == waited) {
			app.emit("done");
		}
		return true;
	}, 'on af st');

	/**
	 * require to wait an additional operation
	 * @method wait
	 * @memberof async.Async#
	 */
	app.bind("wait", function () {
		waited += 1;
	}, 'on af st');

	/**
	 * require to reserve index {@link async.Async#index} for an additional operation
	 * @method reserve
	 * @memberof async.Async#
	 * @returns {string}
	 */
	app.bind("reserve", function () {
		waited += 1;
		return app.index();
	}, 'on af st');

	/**
	 * require to run an operation
	 * @method run
	 * @memberof async.Async#
	 * @param {function():void} func function that should be executed
	 * @param {any[]} args 
	 * @param {object} context
	 * @returns {string}
	 */
	app.bind("run", function (func, args, context) {
		var id = app.index();
		responsesId.push(id);
		waited+=1;
		func.apply(context, args);
		return id;
	}, 'on af st');

	/**
	 * reset operation processing
	 * @method flush
	 * @memberof async.Async#
	 */
	app.bind("flush", function () {
		life		+= 1;
		responses	= {};
		responsesId	= [];
		received	= 0;
		waited		= 0;
	}, 'on af st');

	/**
	 * return how many operations are processing right now
	 * @method processing
	 * @memberof async.Async#
	 * @returns {number}
	 */
	app.bind('processing', function () {
		return ( waited - received );
	}, '');

	/**
	 * return operations' responses
	 * @method responses
	 * @memberof async.Async#
	 * @param {boolean} [returnUnknownResponses=false]
	 * @returns {any[][]}
	 */
	app.bind('responses', function (id) {
		if (id === true) {
			return responsesId.map(function (v) {
				return (v in responses ? responses[v] : undefined);
			});
		}
		return responses;
	});

	/**
	 * return all errors found in responses
	 * @method errors
	 * @memberof async.Async#
	 * @returns {Error[]}
	 */
	app.bind('errors', function () {
		var errs	= [];
		responsesId.forEach(function (id) {
			var r = responses[id];
			if (r instanceof Error) {
				errs.push(r);
			} else {
				var i;
				for (i=0;i&lt;r.length;i++) {
					if (r[i] instanceof Error) {
						errs.push(r[i]);
					}
				}
			}
		});
		return errs;
	});

	/**
	 * register a callback to be called when processing is done 
	 * @method done
	 * @memberof async.Async#
	 * @param {function():void} cb
	 */
	app.bind('done', function (cb) {
		if (typeof(cb) === "function") {
			app.on('done', cb);
			if (received === waited &amp;&amp; received) {
				cb.apply(app, []);
			}
		}
	});

	return app;
};

/**
 * @typedef {Array} async.Async~Operation
 * @property {async.Async~OperationCallback} 0
 * @property {async.Async~OperationArgs} 1
 * @property {async.Async~OperationContext} 2
 * @property {async.Async~OperationCallbackIndex} 3 
 */

/**
 * @typedef {Array&lt;Array&lt;Function, any[], object, number>>} async.Async~Operation
 */

/**
 * a function that represents the operation itself, it have as argument `next` callback, by default it is first.
 * @typedef {Function} async.Async~OperationCallback
 */

/**
 * list if arguments passed to `OperationCallback`.
 * @typedef {any[]} async.Async~OperationArgs
 */

/**
 * context that should be used in `OperationCallback`. Default value is `{}`.
 * @typedef {object} async.Async~OperationContext
 */

/**
 * index of `next()` callback in list of `OperationCallback`'s arguments. Default value is `0`.
 * @typedef {number} async.Async~OperationCallbackIndex
 */

/**
 * @typedef {async.Async~Operation[]} async.Async~Operations
 */

/**
 * @callback async.processCallback
 * @param {function(Error?): void} next
 * @param {any} item
 * @param {number} index
 * @param {any[]} items
 */

/**
 * @callback async.doneCallback
 * @this async.Async
 */

/**
 * @method flow
 * @memberof async.
 * @param {async.Async~Operations} operations
 * @param {async.doneCallback} cb
 * @param {number} [timeout=0] timeout between operations
 * @returns {async.Async}
 */
async.flow	= function (operations, cb, timeout) {
	if (typeof(operations) !== "undefined" &amp;&amp; Array.isArray(operations)) {
		var app = new async();
		app.done(cb);
		var c = {};
		timeout		= timeout || 0;
		var i = 0;
		if (operations.length === 0) {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; operations.length) {
				var op	= operations[i++];
				if (op) {
					var ar	= op[1] || [];
					var ai	= op[3] || 0;
					var id	= app.reserve();
					ar[ai]	= function () {
						app.receive(id, arguments);
					};
					var err;
					setTimeout(function () {
						try {
							op[0].apply(op[2] || c, ar);
						} catch (err) {
							app.receive(id, err);
							app.emit('error', [err]);
						}
					}, timeout);
				}
			}
		};
		app.on('onReceive', function () {
			// console.log("tick");
			tick();
		});
		tick();
		return app;
	}
	return;
};


/**
 * @method waterfall
 * @memberof async.
 * @param {async.Async~Operations} operations
 * @param {async.doneCallback} cb
 * @param {number} [parallel=27] number of operations that can be done in parallel
 * @param {number} [timeout=0] timeout between operations
 * @returns {async.Async}
 */
async.waterfall	= function (ops, cb, parallel, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		app.done(cb);
		var c = {};
		timeout		= timeout || 0;
		if (typeof(parallel) !== "number") {
			parallel	= 27;
		}
		var i = 0;
		if (ops.length === 0) {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				if (op) {
					var ar	= op[1] || [];
					var ai	= op[3] || 0;
					var id	= app.reserve();
					ar[ai]	= function () {
						app.receive(id, arguments);
					};
					var err;
					setTimeout(function () {
						try {
							op[0].apply(op[2] || c, ar);
						} catch (err) {
							app.receive(id, err);
							app.emit('error', [err]);
						}
					}, timeout);
				}
				return true;
			}
			return false;
		};
		app.on('onReceive', function () {
			// console.log("tick");
			while (( parallel === 0 || parallel > app.processing()) &amp;&amp; tick()) {
				// true;
			}
		});
		tick();
		return app;
	}
	return;
};




/**
 * @method map
 * @memberof async.
 * @param {any[]} operations
 * @param {async.processCallback}
 * @param {async.doneCallback} cb
 * @param {number} [timeout=0] timeout between operations
 * @returns {async.Async}
 */
/**
 * @method flow路map
 * @memberof async.
 * @param {any[]} operations
 * @param {async.processCallback}
 * @param {async.doneCallback} cb
 * @param {number} [timeout=0] timeout between operations
 * @returns {async.Async}
 */

async.map = async.flow.map	= function (ops, ev, cb, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		var i = 0;
		var ret		= [];
		app.done(function () {
			cb.apply(app,[ret]);
		});
		if (ops.length) {
			ret[ops.length - 1]	= undefined;
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (v, err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						ret[ri]	= v;
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
			}
		};
		app.on('onReceive', function () {
			tick();
		});
		tick();
		return app;
	}
	return;
};


/**
 * @method waterfall路map
 * @memberof async.
 * @param {any[]} operations
 * @param {async.processCallback}
 * @param {async.doneCallback} cb
 * @param {number} [parallel=27] number of operations that can be done in parallel
 * @param {number} [timeout=0] timeout between operations
 * @returns {async.Async}
 */

async.waterfall.map	= function (ops, ev, cb, parallel, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		if (typeof(parallel) !== "number") {
			parallel	= 27;
		}
		var i = 0;
		var ret		= [];
		app.done(function () {
			cb.apply(app,[ret]);
		});
		if (ops.length) {
			ret[ops.length - 1]	= undefined;
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (v, err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						ret[ri]	= v;
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
			}
		};
		app.on('onReceive', function () {
			while (( parallel === 0 || parallel > app.processing()) &amp;&amp; tick()) {
				// true;
			}
		});
		tick();
		return app;
	}
	return;
};


async.filter = async.flow.filter	= function (ops, ev, cb, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		var i = 0;
		var ret		= [];
		app.done(function () {
			cb.apply(app,[ret]);
		});
		if (ops.length) {
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (v, err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						if (v) ret.push(op);
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
			}
		};
		app.on('onReceive', function () {
			tick();
		});
		tick();
		return app;
	}
	return;
};

async.waterfall.filter	= function (ops, ev, cb, parralel, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		if (typeof(parralel) !== "number") {
			parralel	= 27;
		}
		var i = 0;
		var ret		= [];
		app.done(function () {
			cb.apply(app,[ret]);
		});
		if (ops.length) {
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (v, err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						if (v) ret.push(op);
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
				return true;
			}
			return false;
		};
		app.on('onReceive', function () {
			// debugger;
			while (( parralel === 0 || parralel > app.processing()) &amp;&amp; tick()) {
				// true;
			}
		});
		tick();
		return app;
	}
	return;
};



async.forEach = async.flow.forEach	= function (ops, ev, cb, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		var i = 0;
		app.done(function () {
			cb.apply(app,[ops]);
		});
		if (ops.length) {
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
				return true;
			}
			return false;
		};
		app.on('onReceive', function () {
			tick();
		});
		tick();
		return app;
	}
	return;
};

async.waterfall.forEach	= function (ops, ev, cb, parralel, timeout) {
	if (typeof(ops) !== "undefined" &amp;&amp; Array.isArray(ops)) {
		var app = new async();
		var c = {};
		timeout		= timeout || 0;
		if (typeof(parralel) !== "number") {
			parralel	= 27;
		}
		var i = 0;
		app.done(function () {
			cb.apply(app,[ops]);
		});
		if (ops.length) {
		} else {
			app.emit('done');
		}
		var tick	= function () {
			if ( i &lt; ops.length) {
				var op	= ops[i++];
				var id	= app.reserve();
				var ri	= i-1;
				var rr	= function (err) {
					if (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					} else {
						app.receive();
					}
				};
				var err;
				setTimeout(function () {
					try {
						ev.apply(ops, [rr, op, ri, ops]);
					} catch (err) {
						app.receive(id, err);
						app.emit('error', [err]);
					}
				}, timeout);
				return true;
			}
			return false;
		};
		app.on('onReceive', function () {
			while (( parralel === 0 || parralel > app.processing()) &amp;&amp; tick()) {
				// true;
			}
		});
		tick();
		return app;
	}
	return;
};




async.test	= {};
async.test.flow	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var ops = [];
		var i = 0;
		while (i++ &lt; n) {
			ops.push([(function (k) {
				return function (cb) {
					cb(k);
				};
			})(i + 0)]);
		}
		console.log(ops.length);
		var t0 = new Date().valueOf();
		var a1 = async.flow(ops, function () {
			console.log((new Date().valueOf() - t0)/(n * 1000));
		});
		var k=0;
		a1.on('onError', function (err) {
			console.error(err);
		});
		a1.on('onReceive', function () {
			console.log(k++);
		});
		window.a1 = a1;
	});
};

async.test.waterfall	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var ops = [];
		var i = 0;
		while (i++ &lt; n) {
			ops.push([(function (k) {
				return function (cb) {
					cb(k);
				};
			})(i + 0)]);
		}
		console.log(ops.length);
		var t0 = new Date().valueOf();
		var a1 = async.waterfall(ops, function () {
			console.log((new Date().valueOf() - t0)/(n * 1000));
		}, 69);
		var k=0;
		a1.on('onError', function (err) {
			console.error(err);
		});
		a1.on('onReceive', function () {
			console.log(k++);
		});
		window.a1 = a1;
	});
};
async.test.map = async.test.flow.map	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.flow.map(b, function (cb, v, i, arr) {
			console.log(i);
			cb(Math.floor(Math.random() * 1000));
		}, function (r) {
			console.log("DONE", r);
		});
	});
};

async.test.waterfall.map	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.waterfall.map(b, function (cb, v, i, arr) {
			console.log(i);
			cb(Math.floor(Math.random() * 1000));
		}, function (r) {
			console.log("DONE", r);
		});
	});
};


async.test.filter = async.test.flow.filter	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.flow.filter(b, function (cb, v, i, arr) {
			console.log(i);
			cb(Math.random() > 0.5);
		}, function (r) {
			console.log("DONE ", r.length);
		});
	});
};

async.test.waterfall.filter	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.waterfall.filter(b, function (cb, v, i, arr) {
			console.log(i);
			cb(Math.random() > 0.5);
		}, function (r) {
			console.log("DONE ", r.length);
		});
	});
};

async.test.forEach = async.test.flow.forEach	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.flow.forEach(b, function (cb, v, i, arr) {
			console.log(i);
			cb();
		}, function (r) {
			console.log("DONE ", r.length);
		});
	});
};

async.test.waterfall.forEach	= function (n) {
	console.clear();
	global.require('async', function (async) {
		if (typeof(n) !== "number") n = 1000;
		var b = [];
		if (n)
			b[n - 1] = undefined;
		async.waterfall.forEach(b, function (cb, v, i, arr) {
			console.log(i);
			cb();
		}, function (r) {
			console.log("DONE ", r.length);
		});
	});
};




module.exports	= async;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
